<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-11-04 Mon 10:57 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Publishers and Subscriber Activity</title>
<meta name="author" content="Matthew Elwin" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="./../../pubme.css" type="text/css"/>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../index.html"> UP </a>
 |
 <a accesskey="H" href="./../../index.html"> HOME </a>
</div><div id="content" class="content">
<header>
<h1 class="title">Publishers and Subscriber Activity</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org6347998">Tasks</a>
<ul>
<li><a href="#orgdd52b2e">Basic Node</a>
<ul>
<li><a href="#org377622f">Step-by-Step Guide</a></li>
</ul>
</li>
<li><a href="#orgf049851">Custom Parameters</a></li>
<li><a href="#org95dc805">Namespaces</a></li>
<li><a href="#org1867bc2">Service Call</a></li>
</ul>
</li>
<li><a href="#org64390a7">Answers</a>
<ul>
<li><a href="#org8280f23">Basic Node</a>
<ul>
<li><a href="#orgf078fe2">Creating The Workspace</a></li>
<li><a href="#org973b95c">Editing package.xml and setup.py</a></li>
<li><a href="#orgafb0b92">Minimal Node</a></li>
<li><a href="#org9f3989e">Creating the Timer</a></li>
<li><a href="#orgae1b146">Running the turtlesim node</a></li>
<li><a href="#orgf42e1c0">Creating the publisher</a></li>
<li><a href="#orge127f9b">XML Launchfile</a></li>
<li><a href="#orgdfe4825">Subscriber</a></li>
</ul>
</li>
<li><a href="#orgdf94e69">Parameters</a>
<ul>
<li><a href="#org6e7c1b8">Custom Parameters</a></li>
<li><a href="#org60d56b8">Testing the Parameters</a></li>
<li><a href="#org5bfb31f">Parameters in launch file</a></li>
</ul>
</li>
<li><a href="#org6c142ec">Namespaces</a>
<ul>
<li><a href="#org71c381e">Changing the Namespace</a></li>
<li><a href="#org537e7ca">Namespace Launchfile</a></li>
</ul>
</li>
<li><a href="#orged90468">Services</a>
<ul>
<li><a href="#orgd9698ba">Calling the Spawn Service</a></li>
</ul>
</li>
<li><a href="#org345491a">Full Solution</a>
<ul>
<li><a href="#org47dde6a">Do you really want to see it?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc9a4166">Reference</a></li>
<li><a href="#org0c9fe1f">Tutorials</a></li>
</ul>
</div>
</nav>

<div id="outline-container-org6347998" class="outline-2">
<h2 id="org6347998">Tasks</h2>
<div class="outline-text-2" id="text-org6347998">
</div>
<div id="outline-container-orgdd52b2e" class="outline-3">
<h3 id="orgdd52b2e">Basic Node</h3>
<div class="outline-text-3" id="text-orgdd52b2e">
<p>
Create a node that accomplishes the following:
</p>
<ol class="org-ol">
<li>Publishes to <code>cmd_vel</code> at <code>10 Hz</code> and causes the turtle to move forward in the \(x\) direction</li>
<li>Subscribes to <code>pose</code> and, when the turtle's \(x\) coordinate is less than 2 or greater than 7 reverses the turtle direction</li>
</ol>
</div>

<div id="outline-container-org377622f" class="outline-4">
<h4 id="org377622f">Step-by-Step Guide</h4>
<div class="outline-text-4" id="text-org377622f">
<p>
Here is an approximate step-by-step guide.
</p>
<ol class="org-ol">
<li>Create a new ROS <a href="../colcon.html#workspace">workspace</a></li>
<li>Create a new <a href="../colcon.html#ament_python"><code>ament_python</code> package</a>
<ul class="org-ul">
<li>After calling <code>ros2 pkg create ...</code> is a good time to init the <code>git</code> repository and make the first commit</li>
<li>After editing <code>package.xml</code>, <code>setup.py</code> and creating the <code>README.md</code> is a good time for the second commit.</li>
</ul></li>
<li>Create a minimal ROS node:
<ul class="org-ul">
<li>At first, all that is needed is an entry point that logs a message:
<ol class="org-ol">
<li>Create the python file to hold the node, the node class, and the entry point function</li>
<li>Add the entry point to the <code>setup.py</code></li>
<li>Build the workspace, run, make sure it works, and commit to <code>git</code></li>
</ol></li>
</ul></li>
<li>Next, create a timer. At first the timer just logs information  so that you know the timer is running.
<ul class="org-ul">
<li>After the timer runs successfully, commit to <code>git</code></li>
</ul></li>
<li>Run the <a href="http://docs.ros.org/en/jazzy/Tutorials/Beginner-CLI-Tools/Introducing-Turtlesim/Introducing-Turtlesim.html">turtlesim</a> node.
<ul class="org-ul">
<li>You can use <code>ros2</code> commands to find out information about the turtlesim</li>
<li>The <code>turtlesim</code> also has documentation on <a href="http://index.ros.org">http://index.ros.org</a></li>
<li>The ROS 1 documentation on the wiki (linked to on <a href="http://index.ros.org">http://index.ros.org</a>) still provides accurate descriptions of the <code>turtlesim</code> ROS API.</li>
</ul></li>
<li>Create a publisher that publishes on the <code>cmd_vel</code> topic (use a relative topic name)
<ul class="org-ul">
<li>Publish the command required to accomplish the task</li>
<li>Update the <code>package.xml</code> with the package that contains the message type used</li>
<li>Use <code>ros2 topic</code> to verify that the command is publishing the correct information at the correct frequency.</li>
<li>Commit to <code>git</code></li>
</ul></li>
<li>Using <code>ros2 run</code> start the <code>turtlesim</code> and your node.
<ul class="org-ul">
<li>Make sure to <code>remap</code> the <code>cmd_vel</code> argument to <code>turtle1/cmd_vel</code> when you run your node</li>
<li>See <a href="../ros_api.html#names">Naming in ROS</a> for more information</li>
<li>Adjust code as needed until this step works, and commit to <code>git</code> (at least once when the task is complete).</li>
</ul></li>
<li>Write an XML launchfile called <code>two_pubsub.launch.xml</code> to start the <code>turtlesim</code> node and your node. Once it works, commit it to git.
<ul class="org-ul">
<li>Don't forget to add turtlesim as an <code>exec_depend</code>, since your launchfile depends on it.</li>
<li>There are multiple ways to write this launchfile. For this task use the <code>remap</code> tag to <code>remap</code> the topics in your node to the <code>turtlesim</code> topics.</li>
</ul></li>
<li>Now add the subscriber to the node:
<ul class="org-ul">
<li>Update the launchfile to ensure this topic is mapped properly (subscribe to a relative topic name)</li>
<li>At first do nothing in the subscriber other than log a message</li>
<li>Run your node and the <code>turtlesim</code> and make sure the subscriber can be called</li>
<li>Once the subscriber is called, commit to <code>git</code></li>
</ul></li>
<li>Now, make the <code>subscriber</code> control the direction of the turtle
<ul class="org-ul">
<li>The <code>subscriber</code> callback and the <code>timer</code> callback can share information via class member variables initialized in <code>__init__</code>.</li>
</ul></li>
<li>Once you can run the node and have the turtle move back and forth, this task is complete.
<ul class="org-ul">
<li>A git commit is appropriate here.</li>
</ul></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgf049851" class="outline-3">
<h3 id="orgf049851">Custom Parameters</h3>
<div class="outline-text-3" id="text-orgf049851">
<ol class="org-ol">
<li>Control the minimum and maximum \(x\) values using parameters called <code>xmin</code> and <code>xmax</code>.</li>
<li>Make sure the parameters have meaningful default values and have the node log the parameter values to the DEBUG log when it starts.</li>
<li>Test that the node is reading the parameters correctly using <code>ros2 run</code> with debugging enabled for the node and commit to git.</li>
<li>Add the arguments to the launch file that let the user set <code>xmin</code> and <code>xmax</code> during launch.
<ul class="org-ul">
<li>When the launchfile works, commit to git</li>
</ul></li>
<li>See <a href="../basics.html#parameters">Parameters</a> and <a href="../ros_api.html#rclpy">ROS Python API</a> for more information.</li>
</ol>
</div>
</div>

<div id="outline-container-org95dc805" class="outline-3">
<h3 id="org95dc805">Namespaces</h3>
<div class="outline-text-3" id="text-org95dc805">
<ol class="org-ol">
<li>Run two instances of your node and the <code>turtlesim</code> in two separate namespaces with two separate <code>xmin</code> and <code>xmax</code> values.
<ul class="org-ul">
<li>If you implemented your node correctly, you should not need to change any code to accomplish this task.</li>
<li>This exercise should be done using only <code>ros2 run</code></li>
<li>Try to accomplish this without remapping the <code>cmd_vel</code> or <code>pose</code> topics but instead running your node in the correct namespace</li>
<li>See <a href="../ros_api.html#remapping">Name Remapping</a> for more information.</li>
</ul></li>
<li>Write a launchfile called <code>two_pubsub.launch.xml</code> that starts your node and the turtlesim node
<ol class="org-ol">
<li>Use a <code>group</code>, <code>push_ros_namespace</code>, <code>include</code> to include the launchfile made in the previous section but get the included nodes to launch in a different namespaces.</li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-org1867bc2" class="outline-3">
<h3 id="org1867bc2">Service Call</h3>
<div class="outline-text-3" id="text-org1867bc2">
<ol class="org-ol">
<li>When your node starts (and before it begins moving the turtle) spawn two new turtles, one at the <code>xmin</code> and one at the <code>xmax</code> values
<ul class="org-ul">
<li>The <a href="https://docs.ros.org/en/jazzy/Tutorials/Beginner-Client-Libraries/Writing-A-Simple-Py-Service-And-Client.html">ROS 2 Service Client Tutorial</a> may help</li>
<li>You can use <code>rclpy.spin_until_future_complete</code> here as the service is not being called from a callback.</li>
<li>See <a href="../spin.html#service_client">Service Client</a> for more details</li>
</ul></li>
</ol>
</div>
</div>
</div>

<details id="org64390a7"><summary class="header-2">Answers</summary>
<div class="outline-text-2" id="text-org64390a7">
<p>
This section contains the answers. Try to avoid looking at the answers unless you are truly stuck or want to
verify your work after completing the task.
</p>
</div>

<details id="org8280f23"><summary class="header-3">Basic Node</summary>
<details id="orgf078fe2"><summary class="header-4">Creating The Workspace</summary>
<div class="outline-text-4" id="text-orgf078fe2">
<div class="org-src-container">
<pre class="src src-bash">mkdir -p ws/activity/src
<span class="org-builtin">cd</span> ws/activity/src
ros2 pkg create --build-type ament_python pubsub
<span class="org-builtin">cd</span> pubsub
git init
git add package.xml pubsub/__init__.py resource/pubsub
git add setup.cfg setup.py test/test_copyright.py test/test_flake8.py test/test_pep257.py
git commit
</pre>
</div>
</div>
</details>

<details id="org973b95c"><summary class="header-4">Editing package.xml and setup.py</summary>
<div class="outline-text-4" id="text-org973b95c">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>package.xml</label><pre class="src src-xml"><span class="org-nxml-processing-instruction-delimiter">&lt;?</span><span class="org-nxml-processing-instruction-target">xml</span> <span class="org-nxml-processing-instruction-content">version="1.0"</span><span class="org-nxml-processing-instruction-delimiter">?&gt;</span>
<span class="org-nxml-processing-instruction-delimiter">&lt;?</span><span class="org-nxml-processing-instruction-target">xml-model</span> <span class="org-nxml-processing-instruction-content">href="http://download.ros.org/schema/package_format3.xsd" schematypens="http://www.w3.org/2001/XMLSchema"</span><span class="org-nxml-processing-instruction-delimiter">?&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">package</span> <span class="org-nxml-attribute-local-name">format</span>=<span class="org-string">"3"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">name</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">pubsub</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">name</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">version</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">0.1.0</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">version</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">description</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">A pubsub Demo</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">description</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">maintainer</span> <span class="org-nxml-attribute-local-name">email</span>=<span class="org-string">"youremail@domain.edu"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">Your Name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">maintainer</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">license</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">GPLv3</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">license</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">exec_depend</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">rclpy</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">exec_depend</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">test_depend</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">ament_copyright</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">test_depend</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">test_depend</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">ament_flake8</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">test_depend</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">test_depend</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">ament_pep257</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">test_depend</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">test_depend</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">python3-pytest</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">test_depend</span><span class="org-nxml-tag-delimiter">&gt;</span>

  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">export</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">build_type</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">ament_python</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">build_type</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">export</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">package</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>setup.py</label><pre class="src src-python"><span class="org-keyword">from</span> setuptools <span class="org-keyword">import</span> find_packages, setup

<span class="org-variable-name">package_name</span> <span class="org-operator">=</span> <span class="org-string">'pubsub'</span>

setup(
    name<span class="org-operator">=</span>package_name,
    version<span class="org-operator">=</span><span class="org-string">'0.0.0'</span>,
    packages<span class="org-operator">=</span>find_packages(exclude<span class="org-operator">=</span>[<span class="org-string">'test'</span>]),
    data_files<span class="org-operator">=</span>[
        (<span class="org-string">'share/ament_index/resource_index/packages'</span>,
            [<span class="org-string">'resource/'</span> <span class="org-operator">+</span> package_name]),
        (<span class="org-string">'share/'</span> <span class="org-operator">+</span> package_name, [<span class="org-string">'package.xml'</span>]),
    ],
    install_requires<span class="org-operator">=</span>[<span class="org-string">'setuptools'</span>],
    zip_safe<span class="org-operator">=</span><span class="org-constant">True</span>,
    maintainer<span class="org-operator">=</span><span class="org-string">'Your Name'</span>,
    maintainer_email<span class="org-operator">=</span><span class="org-string">'youremail@domain.edu'</span>,
    description<span class="org-operator">=</span><span class="org-string">'A pubsub demo'</span>,
    <span class="org-constant">license</span><span class="org-operator">=</span><span class="org-string">'GPLv3'</span>,
    tests_require<span class="org-operator">=</span>[<span class="org-string">'pytest'</span>],
    entry_points<span class="org-operator">=</span>{
        <span class="org-string">'console_scripts'</span>: [
        ],
    },
)
</pre>
</div>

<pre class="example">
# Pub Sub Activity
Author: Your Name

This is an activity to practice with publishers and subscribers and launchfiles
</pre>
</div>
</details>


<details id="orgafb0b92"><summary class="header-4">Minimal Node</summary>
<div class="outline-text-4" id="text-orgafb0b92">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Snippet of setup.py</label><pre class="src src-python"><span class="org-variable-name">entry_points</span><span class="org-operator">=</span>{
   <span class="org-string">'console_scripts'</span>: [
     <span class="org-string">'pubsub_node = pubsub.pubsub:main'</span>
   ],
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>pubsub/pubsub.py</label><pre class="src src-python"><span class="org-keyword">import</span> rclpy
<span class="org-keyword">from</span> rclpy.node <span class="org-keyword">import</span> Node

<span class="org-keyword">class</span> <span class="org-type">PubsubNode</span>(Node):
    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span>(<span class="org-keyword">self</span>):
        <span class="org-builtin">super</span>().__init__(<span class="org-string">"pubsub"</span>)
        <span class="org-keyword">self</span>.get_logger().info(<span class="org-string">"Pubsub Node"</span>)


<span class="org-keyword">def</span> <span class="org-function-name">main</span>(args<span class="org-operator">=</span><span class="org-constant">None</span>):
    rclpy.init(args<span class="org-operator">=</span>args)
    <span class="org-variable-name">pubsub_node</span> <span class="org-operator">=</span> PubsubNode()
    rclpy.spin(pubsub_node)
    pubsub_node.destroy_node()
    rclpy.shutdown()
</pre>
</div>
</div>
</details>

<details id="org9f3989e"><summary class="header-4">Creating the Timer</summary>
<div class="outline-text-4" id="text-org9f3989e">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>pubsub/pubsub.py</label><pre class="src src-python">
<span class="org-comment-delimiter"># </span><span class="org-comment">Just showing the pubsub node</span>
<span class="org-keyword">class</span> <span class="org-type">PubsubNode</span>(Node):
    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span>(<span class="org-keyword">self</span>):
        <span class="org-builtin">super</span>().__init__(<span class="org-string">"pubsub"</span>)
        <span class="org-keyword">self</span>.get_logger().info(<span class="org-string">"Pubsub Node"</span>)
        <span class="org-keyword">self</span>.<span class="org-variable-name">_tmr</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.create_timer(0.1, <span class="org-keyword">self</span>.timer_callback)

    <span class="org-keyword">def</span> <span class="org-function-name">timer_callback</span>(<span class="org-keyword">self</span>):
        <span class="org-keyword">self</span>.get_logger().info(<span class="org-string">"Timer!"</span>)

</pre>
</div>
</div>
</details>

<details id="orgae1b146"><summary class="header-4">Running the turtlesim node</summary>
<div class="outline-text-4" id="text-orgae1b146">
<div class="org-src-container">
<pre class="src src-bash">ros2 run turtlesim turtlesim node
<span class="org-comment-delimiter"># </span><span class="org-comment">In a new window, list all the topics</span>
ros2 topic list
<span class="org-comment-delimiter"># </span><span class="org-comment">Get info on /turtle1/cmd_vel</span>
ros2 topic info /turtle1/cmd_vel

<span class="org-comment-delimiter"># </span><span class="org-comment">See that the type is geometry_msgs/msg/Twist</span>
ros2 interface show geometry_msgs/msg/Twist

<span class="org-comment-delimiter"># </span><span class="org-comment">The linear.x value is what we will want to control</span>
</pre>
</div>
</div>
</details>

<details id="orgf42e1c0"><summary class="header-4">Creating the publisher</summary>
<div class="outline-text-4" id="text-orgf42e1c0">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>In pubsub/pubsub.py</label><pre class="src src-python"><span class="org-keyword">from</span> geometry_msgs.msg <span class="org-keyword">import</span> Twist, Vector3

<span class="org-comment-delimiter"># </span><span class="org-comment">create the publisher in PubsubNode.__init__</span>
<span class="org-keyword">self</span>.<span class="org-variable-name">_pub</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.create_publisher(Twist, <span class="org-string">"cmd_vel"</span>, 10)
<span class="org-keyword">self</span>.<span class="org-variable-name">_velocity</span> <span class="org-operator">=</span> 2.0

<span class="org-comment-delimiter"># </span><span class="org-comment">In the timer</span>
<span class="org-keyword">self</span>._pub.publish(Twist(linear<span class="org-operator">=</span>Vector3(x<span class="org-operator">=</span><span class="org-keyword">self</span>._velocity)))
</pre>
</div>

<p>
Verify the message is published at the correct frequency. Includes remapping the topic
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter"># </span><span class="org-comment">Commands may need to be run in separate terminals or backgrounded</span>
ros2 run pubsub pubsub --ros-args -r cmd_vel:=turtle1/cmd_vel
ros2 topic hz cmd_vel
ros2 topic echo /turtle1/cmd_vel
</pre>
</div>
</div>
</details>

<details id="orge127f9b"><summary class="header-4">XML Launchfile</summary>
<div class="outline-text-4" id="text-orge127f9b">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>launch/pubsub.launch.xml</label><pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">launch</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">node</span> <span class="org-nxml-attribute-local-name">pkg</span>=<span class="org-string">"turtlesim"</span> <span class="org-nxml-attribute-local-name">exec</span>=<span class="org-string">"turtlesim_node"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">node</span> <span class="org-nxml-attribute-local-name">pkg</span>=<span class="org-string">"pubsub"</span> <span class="org-nxml-attribute-local-name">exec</span>=<span class="org-string">"pubsub"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">remap</span> <span class="org-nxml-attribute-local-name">from</span>=<span class="org-string">"cmd_vel"</span> <span class="org-nxml-attribute-local-name">to</span>=<span class="org-string">"turtle1/cmd_vel"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">node</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">launch</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>Snippet of setup.py used to install the launchfiles</label><pre class="src src-python"><span class="org-variable-name">data_files</span><span class="org-operator">=</span>[
    (<span class="org-string">'share/ament_index/resource_index/packages'</span>,
        [<span class="org-string">'resource/'</span> <span class="org-operator">+</span> package_name]),
    (<span class="org-string">'share/'</span> <span class="org-operator">+</span> package_name, [<span class="org-string">'package.xml'</span>]),
    (<span class="org-string">'share/'</span> <span class="org-operator">+</span> package_name <span class="org-operator">+</span> <span class="org-string">'/launch'</span>, [<span class="org-string">'launch/pubsub.launch.xml'</span>])
],
</pre>
</div>
</div>
</details>

<details id="orgdfe4825"><summary class="header-4">Subscriber</summary>
<div class="outline-text-4" id="text-orgdfe4825">
<p>
To find out about the turtlesim pose:
</p>
<div class="org-src-container">
<pre class="src src-bash">ros2 topic list
ros2 topic info /turtle1/pose
ros2 interface show turtlesim/msg/Pose
</pre>
</div>

<ul class="org-ul">
<li>Update the launchfile by adding this remapping to the <code>pubsub</code> node:
<code>&lt;remap from="pose" to="turtle1/pose" /&gt;</code></li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>pubsub/pubsub.py</label><pre class="src src-python"><span class="org-keyword">from</span> turtlesim.msg <span class="org-keyword">import</span> Pose

<span class="org-comment-delimiter"># </span><span class="org-comment">in PubsubNode.__init__:</span>
<span class="org-keyword">self</span>.<span class="org-variable-name">_sub</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.create_subscription(Pose, <span class="org-string">"pose"</span>, <span class="org-keyword">self</span>.pose_callback, 10)

<span class="org-comment-delimiter"># </span><span class="org-comment">Add the callback</span>
<span class="org-keyword">def</span> <span class="org-function-name">pose_callback</span>(<span class="org-keyword">self</span>, pose):
    <span class="org-doc">"""Update the pose of the robot"""</span>
    <span class="org-keyword">if</span> pose.x <span class="org-operator">&gt;</span> 7 <span class="org-keyword">and</span> <span class="org-keyword">self</span>._velocity <span class="org-operator">&gt;</span> 0:
        <span class="org-keyword">self</span>.<span class="org-variable-name">_velocity</span> <span class="org-operator">*=</span> <span class="org-operator">-</span>1.0
    <span class="org-keyword">elif</span> pose.x <span class="org-operator">&lt;</span> 2 <span class="org-keyword">and</span> <span class="org-keyword">self</span>._velocity <span class="org-operator">&lt;</span> 0:
        <span class="org-keyword">self</span>.<span class="org-variable-name">_velocity</span> <span class="org-operator">*=</span> <span class="org-operator">-</span>1.0
</pre>
</div>
</div>
</details>
</details>

<details id="orgdf94e69"><summary class="header-3">Parameters</summary>
<details id="org6e7c1b8"><summary class="header-4">Custom Parameters</summary>
<div class="outline-text-4" id="text-org6e7c1b8">
<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">In PubsubNode.__init__</span>
<span class="org-keyword">self</span>.declare_parameter(<span class="org-string">"xmin"</span>, 2.0)
<span class="org-keyword">self</span>.<span class="org-variable-name">_xmin</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.get_parameter(<span class="org-string">"xmin"</span>).value
<span class="org-keyword">self</span>.declare_parameter(<span class="org-string">"xmax"</span>, 2.0)
<span class="org-keyword">self</span>.<span class="org-variable-name">_xmax</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.get_parameter(<span class="org-string">"xmax"</span>).value
<span class="org-keyword">self</span>.get_logger().debug(f<span class="org-string">"Xmin: </span>{<span class="org-keyword">self</span>._xmin}<span class="org-string"> Xmax: </span>{<span class="org-keyword">self</span>._xmax}<span class="org-string">"</span>)

<span class="org-comment-delimiter"># </span><span class="org-comment">Now the subscriber can use self._xmin and self._xmax instead of hard-coded values</span>
</pre>
</div>
</div>
</details>

<details id="org60d56b8"><summary class="header-4">Testing the Parameters</summary>
<div class="outline-text-4" id="text-org60d56b8">
<p>
To test the node: <code>ros2 run pubsub pubsub --ros-args -p xmin:=3.1 -p xmax:=6.5 --log-level pubsub:=DEBUG</code>
</p>
</div>
</details>


<details id="org5bfb31f"><summary class="header-4">Parameters in launch file</summary>
<div class="outline-text-4" id="text-org5bfb31f">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>pubsub.launch.xml for the pubsub node:</label><pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">node</span> <span class="org-nxml-attribute-local-name">pkg</span>=<span class="org-string">"pubsub"</span> <span class="org-nxml-attribute-local-name">exec</span>=<span class="org-string">"pubsub"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">remap</span> <span class="org-nxml-attribute-local-name">from</span>=<span class="org-string">"cmd_vel"</span> <span class="org-nxml-attribute-local-name">to</span>=<span class="org-string">"turtle1/cmd_vel"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">remap</span> <span class="org-nxml-attribute-local-name">from</span>=<span class="org-string">"pose"</span> <span class="org-nxml-attribute-local-name">to</span>=<span class="org-string">"turtle1/pose"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">param</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"xmin"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"$(var xmin)"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">param</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"xmax"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"$(var xmax)"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">node</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
</div>
</details>
</details>

<details id="org6c142ec"><summary class="header-3">Namespaces</summary>
<div id="outline-container-org71c381e" class="outline-4">
<h4 id="org71c381e">Changing the Namespace</h4>
<div class="outline-text-4" id="text-org71c381e">
<div class="org-src-container">
<pre class="src src-bash">ros2 run turtlesim turtlesim_node --ros-args -r __ns:=/ns1
ros2 run pubsub pubsub --ros-args -r __ns:=/ns1/turtle1
ros2 run turtlesim turtlesim_node --ros-args -r __ns:=/ns2
ros2 run pubsub pubsub --ros-args -r __ns:=/ns2/turtle1 -p xmin:=1.0 -p xmax:=6.0
</pre>
</div>
</div>
</div>

<details id="org537e7ca"><summary class="header-4">Namespace Launchfile</summary>
<div class="outline-text-4" id="text-org537e7ca">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>two_pubsub.launch.xml</label><pre class="src src-python"><span class="org-operator">&lt;</span>!<span class="org-operator">--</span> Command two turtles <span class="org-keyword">in</span> two turtle sims <span class="org-operator">--&gt;</span>
<span class="org-operator">&lt;</span>launch<span class="org-operator">&gt;</span>
  <span class="org-operator">&lt;</span>group<span class="org-operator">&gt;</span>
    <span class="org-operator">&lt;</span>push_ros_namespace namespace<span class="org-operator">=</span><span class="org-string">"ns1"</span><span class="org-operator">/&gt;</span>
    <span class="org-operator">&lt;</span>include <span class="org-builtin">file</span><span class="org-operator">=</span><span class="org-string">"$(find-pkg-share pubsub)/launch/pubsub.launch.xml"</span> <span class="org-operator">/&gt;</span>
  <span class="org-operator">&lt;/</span>group<span class="org-operator">&gt;</span>

  <span class="org-operator">&lt;</span>group<span class="org-operator">&gt;</span>
    <span class="org-operator">&lt;</span>push_ros_namespace namespace<span class="org-operator">=</span><span class="org-string">"ns2"</span><span class="org-operator">/&gt;</span>
    <span class="org-operator">&lt;</span>include <span class="org-builtin">file</span><span class="org-operator">=</span><span class="org-string">"$(find-pkg-share pubsub)/launch/pubsub.launch.xml"</span> <span class="org-operator">/&gt;</span>
  <span class="org-operator">&lt;/</span>group<span class="org-operator">&gt;</span>
<span class="org-operator">&lt;/</span>launch<span class="org-operator">&gt;</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>Snippet that installs the new launchfile in <code>setup.py</code>:</label><pre class="src src-python"><span class="org-variable-name">data_files</span><span class="org-operator">=</span>[
    (<span class="org-string">'share/ament_index/resource_index/packages'</span>,
        [<span class="org-string">'resource/'</span> <span class="org-operator">+</span> package_name]),
    (<span class="org-string">'share/'</span> <span class="org-operator">+</span> package_name, [<span class="org-string">'package.xml'</span>]),
    (<span class="org-string">'share/'</span> <span class="org-operator">+</span> package_name <span class="org-operator">+</span> <span class="org-string">'/launch'</span>, [<span class="org-string">'launch/pubsub.launch.xml'</span>, <span class="org-string">'launch/two_pubsub.launch.xml'</span>])
],
</pre>
</div>
</div>
</details>
</details>

<details id="orged90468"><summary class="header-3">Services</summary>
<details id="orgd9698ba"><summary class="header-4">Calling the Spawn Service</summary>
<div class="outline-text-4" id="text-orgd9698ba">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>PubsubNode.__init__</label><pre class="src src-python"><span class="org-variable-name">spawn_client</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.create_client(Spawn, <span class="org-string">"spawn"</span>)
<span class="org-keyword">if</span> <span class="org-keyword">not</span> spawn_client.wait_for_service(timeout_sec <span class="org-operator">=</span> 2.0):
    <span class="org-keyword">raise</span> <span class="org-type">RuntimeError</span>(<span class="org-string">"Failed to find spawn service."</span>)
rclpy.spin_until_future_complete(<span class="org-keyword">self</span>, spawn_client.call_async(Spawn.Request(x<span class="org-operator">=</span><span class="org-keyword">self</span>._xmin, y<span class="org-operator">=</span>5.54)))
rclpy.spin_until_future_complete(<span class="org-keyword">self</span>, spawn_client.call_async(Spawn.Request(x<span class="org-operator">=</span><span class="org-keyword">self</span>._xmax, y<span class="org-operator">=</span>5.54)))
</pre>
</div>
</div>
</details>
</details>

<details id="org345491a"><summary class="header-3">Full Solution</summary>
<details id="org47dde6a"><summary class="header-4">Do you really want to see it?</summary>
<details id="org441137a"><summary class="header-5">Are you sure?</summary>
<div class="outline-text-5" id="text-org441137a">
<p>
The full solution is at <a href="https://github.com/m-elwin/me495_pubsub">https://github.com/m-elwin/me495_pubsub</a>.
</p>
</div>
</details>
</details>
</details>
</details>
<div id="outline-container-orgc9a4166" class="outline-2">
<h2 id="orgc9a4166">Reference</h2>
<div class="outline-text-2" id="text-orgc9a4166">
<ul class="org-ul">
<li><a href="../basics.html">ROS Basics</a> (and references therein).</li>
<li><a href="../ros_api.html">ROS API</a> (and references therein).</li>
</ul>
</div>
</div>

<div id="outline-container-org0c9fe1f" class="outline-2">
<h2 id="org0c9fe1f">Tutorials</h2>
<div class="outline-text-2" id="text-org0c9fe1f">
<ul class="org-ul">
<li><a href="https://docs.ros.org/en/jazzy/Tutorials/Beginner-CLI-Tools.html">Beginner CLI Tools</a></li>
<li><a href="https://docs.ros.org/en/jazzy/Tutorials/Beginner-Client-Libraries.html">Beginner Client Libraries</a></li>
<li><a href="https://docs.ros.org/en/jazzy/Tutorials/Beginner-Client-Libraries/Creating-A-Workspace/Creating-A-Workspace.html">Workspace</a></li>
<li><a href="https://docs.ros.org/en/jazzy/Tutorials/Beginner-Client-Libraries/Creating-Your-First-ROS2-Package.html">Package</a></li>
<li><a href="https://docs.ros.org/en/jazzy/Tutorials/Beginner-Client-Libraries/Writing-A-Simple-Py-Publisher-And-Subscriber.html">Publisher and Subscriber</a></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p><p class="outline-2">Author: Matthew Elwin. </p></p>
</div>
</body>
</html>
